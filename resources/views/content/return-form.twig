{% extends "Ceres::PageDesign.PageDesign" %}

{% block PageBody %}
<div class="returns-portal-form container mt-5">
    <div class="row">
        <div class="col-12">
            <h1 class="h2 mb-4">{{ trans("ReturnsPortal::Template.createReturnTitle") }}</h1>
            
            {% if not validation.eligible %}
                <div class="alert alert-warning">
                    <strong>{{ trans("ReturnsPortal::Template.notEligible") }}</strong>
                    <p>{{ validation.message }}</p>
                </div>
            {% else %}
                <div class="card mb-4">
                    <div class="card-header">
                        <h3 class="h5 mb-0">{{ trans("ReturnsPortal::Template.orderDetails") }}</h3>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <p><strong>{{ trans("ReturnsPortal::Template.orderNumber") }}:</strong> #{{ order.id }}</p>
                                <p><strong>{{ trans("ReturnsPortal::Template.orderDate") }}:</strong> {{ order.createdAt | date("d.m.Y") }}</p>
                            </div>
                            <div class="col-md-6">
                                <p><strong>{{ trans("ReturnsPortal::Template.orderTotal") }}:</strong> {{ order.amounts[0].invoiceTotal | currency }}</p>
                                <p><strong>{{ trans("ReturnsPortal::Template.returnDeadline") }}:</strong> {{ validation.deadline | date("d.m.Y") }}</p>
                            </div>
                        </div>
                    </div>
                </div>

                <form id="returnForm" method="POST" action="/returns/store">
                    <input type="hidden" name="order_id" value="{{ order.id }}">
                    
                    <div class="card mb-4">
                        <div class="card-header">
                            <h3 class="h5 mb-0">{{ trans("ReturnsPortal::Template.selectItems") }}</h3>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th width="50">
                                                <input type="checkbox" id="selectAll" class="form-check-input">
                                            </th>
                                            <th>{{ trans("ReturnsPortal::Template.product") }}</th>
                                            <th>{{ trans("ReturnsPortal::Template.quantity") }}</th>
                                            <th>{{ trans("ReturnsPortal::Template.price") }}</th>
                                            <th>{{ trans("ReturnsPortal::Template.returnQty") }}</th>
                                            <th>{{ trans("ReturnsPortal::Template.reason") }}</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for item in orderItems %}
                                            {% if item.typeId == 1 %}
                                                <tr>
                                                    <td>
                                                        <input type="checkbox" 
                                                               class="form-check-input item-checkbox" 
                                                               name="items[{{ loop.index }}][selected]" 
                                                               value="1"
                                                               data-item-id="{{ item.id }}">
                                                    </td>
                                                    <td>
                                                        <strong>{{ item.orderItemName }}</strong><br>
                                                        <small class="text-muted">SKU: {{ item.itemVariationId }}</small>
                                                    </td>
                                                    <td>{{ item.quantity }}</td>
                                                    <td>{{ item.amounts[0].priceGross | currency }}</td>
                                                    <td>
                                                        <input type="number" 
                                                               class="form-control form-control-sm" 
                                                               name="items[{{ loop.index }}][quantity]" 
                                                               min="1" 
                                                               max="{{ item.quantity }}" 
                                                               value="{{ item.quantity }}"
                                                               style="width: 80px;"
                                                               disabled>
                                                        <input type="hidden" name="items[{{ loop.index }}][order_item_id]" value="{{ item.id }}">
                                                        <input type="hidden" name="items[{{ loop.index }}][item_variation_id]" value="{{ item.itemVariationId }}">
                                                        <input type="hidden" name="items[{{ loop.index }}][item_name]" value="{{ item.orderItemName }}">
                                                        <input type="hidden" name="items[{{ loop.index }}][price]" value="{{ item.amounts[0].priceGross }}">
                                                    </td>
                                                    <td>
                                                        <select class="form-select form-select-sm" 
                                                                name="items[{{ loop.index }}][reason]" 
                                                                disabled>
                                                            <option value="">{{ trans("ReturnsPortal::Template.selectReason") }}</option>
                                                            {% for reason in returnReasons %}
                                                                <option value="{{ reason.value }}">{{ reason.label[lang] }}</option>
                                                            {% endfor %}
                                                        </select>
                                                    </td>
                                                </tr>
                                            {% endif %}
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <div class="card mb-4">
                        <div class="card-header">
                            <h3 class="h5 mb-0">{{ trans("ReturnsPortal::Template.additionalInfo") }}</h3>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">{{ trans("ReturnsPortal::Template.contactName") }}*</label>
                                    <input type="text" class="form-control" name="customer_name" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">{{ trans("ReturnsPortal::Template.email") }}*</label>
                                    <input type="email" class="form-control" name="customer_email" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">{{ trans("ReturnsPortal::Template.phone") }}</label>
                                    <input type="tel" class="form-control" name="customer_phone">
                                </div>
                                <div class="col-12 mb-3">
                                    <label class="form-label">{{ trans("ReturnsPortal::Template.additionalComments") }}</label>
                                    <textarea class="form-control" name="customer_notes" rows="4" placeholder="{{ trans('ReturnsPortal::Template.commentsPlaceholder') }}"></textarea>
                                </div>
                                <div class="col-12 mb-3">
                                    <label class="form-label">{{ trans("ReturnsPortal::Template.uploadPhotos") }}</label>
                                    <input type="file" class="form-control" id="returnImages" multiple accept="image/*">
                                    <small class="form-text text-muted">{{ trans("ReturnsPortal::Template.photosHelp") }}</small>
                                    <div id="imagePreview" class="mt-2"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="d-flex justify-content-between">
                        <a href="/my-orders" class="btn btn-secondary">
                            {{ trans("ReturnsPortal::Template.cancel") }}
                        </a>
                        <button type="submit" class="btn btn-primary" id="submitReturn">
                            <span class="spinner-border spinner-border-sm d-none" role="status"></span>
                            {{ trans("ReturnsPortal::Template.submitReturn") }}
                        </button>
                    </div>
                </form>
            {% endif %}
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('returnForm');
    const selectAllCheckbox = document.getElementById('selectAll');
    const itemCheckboxes = document.querySelectorAll('.item-checkbox');
    const submitButton = document.getElementById('submitReturn');

    // Select all functionality
    selectAllCheckbox.addEventListener('change', function() {
        itemCheckboxes.forEach(checkbox => {
            checkbox.checked = this.checked;
            toggleItemInputs(checkbox);
        });
    });

    // Individual checkbox handling
    itemCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            toggleItemInputs(this);
        });
    });

    function toggleItemInputs(checkbox) {
        const row = checkbox.closest('tr');
        const inputs = row.querySelectorAll('input[type="number"], select');
        inputs.forEach(input => {
            input.disabled = !checkbox.checked;
        });
    }

    // Form submission
    form.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        // Validate at least one item is selected
        const selectedItems = document.querySelectorAll('.item-checkbox:checked');
        if (selectedItems.length === 0) {
            alert('{{ trans("ReturnsPortal::Template.selectAtLeastOne") }}');
            return;
        }

        // Show loading
        submitButton.disabled = true;
        submitButton.querySelector('.spinner-border').classList.remove('d-none');

        try {
            const formData = new FormData(form);
            const response = await fetch('/returns/store', {
                method: 'POST',
                body: formData
            });

            const result = await response.json();

            if (result.success) {
                window.location.href = result.trackingUrl;
            } else {
                alert(result.message);
                submitButton.disabled = false;
                submitButton.querySelector('.spinner-border').classList.add('d-none');
            }
        } catch (error) {
            alert('{{ trans("ReturnsPortal::Template.errorSubmitting") }}');
            submitButton.disabled = false;
            submitButton.querySelector('.spinner-border').classList.add('d-none');
        }
    });

    // Image upload handling
    document.getElementById('returnImages').addEventListener('change', function(e) {
        const preview = document.getElementById('imagePreview');
        preview.innerHTML = '';
        
        for (let file of e.target.files) {
            const reader = new FileReader();
            reader.onload = function(event) {
                const img = document.createElement('img');
                img.src = event.target.result;
                img.className = 'img-thumbnail me-2 mb-2';
                img.style.width = '100px';
                img.style.height = '100px';
                img.style.objectFit = 'cover';
                preview.appendChild(img);
            };
            reader.readAsDataURL(file);
        }
    });
});
</script>
{% endblock %}
